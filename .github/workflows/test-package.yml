name: Test package manager execution
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to test, i.e latest, 1.0.0. Default latest"
        required: false
        default: latest

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]
        package-manager:
          [
            { name: "pnpm", exec: "pnpm dlx" },
            { name: "npm", exec: "npm -y x" }
          ]
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: "Install package manager"
        run: npm install -g ${{ matrix.package-manager.name }}
      - name: Check if Plasmo command works
        run: ${{ matrix.package-manager.exec }} plasmo@${{ github.event.inputs.tag }} version
      - name: Check if plasmo init works at all
        run: echo "testdir" | ${{ matrix.package-manager.exec }} plasmo@${{ github.event.inputs.tag }} init --verbose
      - name: Check if building is possible and if it built
        run: |
          pushd testdir
          ${{ matrix.package-manager.name }} run build
          pushd build
          popd
          timeout --preserve-status 10 ${{ matrix.package-manager.name }} run dev
